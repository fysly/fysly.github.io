<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="互联网,GFW," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/logo.png?v=5.0.1" />






<meta name="description" content="中国大陆的网络问题可以说早已不是秘密，在此我也没必要拐弯抹角——当然要从 GFW 说起。下面尽量用普通人都能听懂的语言来解释。
起因
当我们在浏览器地址栏输入 https://www.google.com 时，我们自然是希望能够访问谷歌这个网站。但浏览器怎么知道我们输入的这串字符是什么意思？其实浏览器并不知道，是 DNS 告诉它的。DNS 相当于一本网络通讯录，当我们要去谷歌家时，只需报上谷歌大名">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Pcap_DNSProxy 获得正确的 DNS 解析">
<meta property="og:url" content="https://fysly.github.io/Get-Correct-DNS-Resolve-by-Pcap_DNSProxy/index.html">
<meta property="og:site_name" content="喧嘩両成敗">
<meta property="og:description" content="中国大陆的网络问题可以说早已不是秘密，在此我也没必要拐弯抹角——当然要从 GFW 说起。下面尽量用普通人都能听懂的语言来解释。
起因
当我们在浏览器地址栏输入 https://www.google.com 时，我们自然是希望能够访问谷歌这个网站。但浏览器怎么知道我们输入的这串字符是什么意思？其实浏览器并不知道，是 DNS 告诉它的。DNS 相当于一本网络通讯录，当我们要去谷歌家时，只需报上谷歌大名">
<meta property="og:updated_time" content="2017-01-10T13:36:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 Pcap_DNSProxy 获得正确的 DNS 解析">
<meta name="twitter:description" content="中国大陆的网络问题可以说早已不是秘密，在此我也没必要拐弯抹角——当然要从 GFW 说起。下面尽量用普通人都能听懂的语言来解释。
起因
当我们在浏览器地址栏输入 https://www.google.com 时，我们自然是希望能够访问谷歌这个网站。但浏览器怎么知道我们输入的这串字符是什么意思？其实浏览器并不知道，是 DNS 告诉它的。DNS 相当于一本网络通讯录，当我们要去谷歌家时，只需报上谷歌大名">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: "",
      labels: ""
    }
  };
</script>







  <title> 使用 Pcap_DNSProxy 获得正确的 DNS 解析 | 喧嘩両成敗 </title>
</head>

<!-- move jquery here for loading (originally placed in "_scripts/vendors.swig") -->
<script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <!-- update loading -->
    
    <script type="text/javascript">
        $('.headband').animate({'width':'10%'}, 150);
    </script>
    

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">喧嘩両成敗</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">随便写点东西</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          
          <a href="/" rel="section" >
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          
          <a href="/archives" rel="section" >
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          
          <a href="/tags" rel="section" >
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          
          <a href="/about" rel="section" >
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>
 </div>
    </header>

    <!-- update loading -->
    
    <script type="text/javascript">
        $('.headband').animate({'width':'30%'}, 150);
    </script>
    

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://fysly.github.io/Get-Correct-DNS-Resolve-by-Pcap_DNSProxy/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="fysly">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/logo.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="喧嘩両成敗">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="喧嘩両成敗" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                使用 Pcap_DNSProxy 获得正确的 DNS 解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-22T15:29:42+08:00">
              2016-02-22
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2017-01-10T21:36:58+08:00">
              2017-01-10
            </time>

          </span>

          

          
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>中国大陆的网络问题可以说早已不是秘密，在此我也没必要拐弯抹角——当然要从 GFW 说起。下面尽量用普通人都能听懂的语言来解释。</p>
<h2 id="起因">起因</h2>
<p>当我们在浏览器地址栏输入 https://www.google.com 时，我们自然是希望能够访问谷歌这个网站。但浏览器怎么知道我们输入的这串字符是什么意思？其实浏览器并不知道，是 DNS 告诉它的。DNS 相当于一本网络通讯录，当我们要去谷歌家时，只需报上谷歌大名，浏览器便会这本厚厚的通讯录里找到谷歌的名字，然后把谷歌的家庭地址告诉我们，于是我们就能去谷歌家了。若是没有 DNS，我们就不能靠这些十分好记的网址来访问网址，而必须输入 <code>192.168.100.100</code> 这样的地址才行（这个地址不是真实地址，明白就行）。</p>
<a id="more"></a>
<p>那么，什么是 DNS 污染？简单地说，就是利用某些投毒手段，人为地污染了这本通讯录，把很多错误的地址放到谷歌名字第下。因此，当我们报上谷歌大名时，被污染了的 DNS 就会把错误地址返回，结果浏览器就照着这个错误地址去访问，自然也就无法到达谷歌了。</p>
<p>这些错误地址，有时候是根本不存在的假地址，有时候是真实存在的地址。试想一下，谷歌那么大的网址，自然有很大的流量，如果 DNS 给了错误的地址，把这么庞大的流量引到某个小网站上，这个网址相当于遭受了一场大型 DDOS 攻击，将直接瘫痪。而这样的事情，也确实发生了。可以想象那些小站站长的心理阴影面积。</p>
<blockquote>
<ul>
<li>2010年3月，当美国和智利的用户试图访问热门社交网站如 facebook.com 和 youtube.com 还有 twitter.com 等域名，他们的域名查询请求转交给中国控制的 DNS 根镜像服务器处理，由于这些网站在中国被封锁，结果用户收到了错误的DNS解析信息，这意味着防火长城的DNS域名污染域名劫持已影响国际互联网。</li>
<li>2010年4月8日，中国大陆一个小型 ISP 的错误路由数据，经过中国电信的二次传播，扩散到了整个国际互联网，波及到了 AT&amp;T、Level3 等多个国家的大型 ISP</li>
</ul>
</blockquote>
<p>从此，GFW 不再仅仅只是阻断中国人的网络，还波及了外国友人。</p>
<p>曾经有朋友和我讨论 GFW 的功过是非，他坚持认为这是利大于弊的，理由无非是维护国家稳定等耳熟能详的论调。作为朋友，我无法当场翻脸，即使在我看来这是毫无争议的话题。当时我告诉他——退一万步说，假设这些所谓的好处都是确实可期的，我们姑且就此达成共识，但即使如此我们也只能说，如果「中国政府掌握了领先世界的科技，能够毫无痕迹地实现 GFW 功能，不造成额外影响」，它才是利大于弊的。</p>
<p>但现实显然并非如此，我们的政府并没有这样的火星科技。为了实现防火墙，他们做了很多遗毒无穷的工作，DNS 污染便是其中之一。</p>
<h2 id="具体问题">具体问题</h2>
<p>简而言之，目前国内几乎所有公共 DNS 都不再是干净的了。为了获取正确的 DNS 解析，不能再像过去那样，直接使用国内公众 DNS。</p>
<p>一个简单的办法是修改本地 hosts 文件。hosts 文件相当于一个本地的小型通讯录，我们在这里写上谷歌的地址，于是不再经过 DNS，而是根据这个地址直接访问谷歌家，简单有效。但被污染的域名如此之多，那些地址又很快会被 GFW 屏蔽，你需要非常频繁地修改 hosts 才行，显然不太靠谱。</p>
<p>办法还有很多，都有各自的优缺点。这里我推荐本文的主角——Pcap_DNSProxy。</p>
<h2 id="pcap-dnsproxy">Pcap_DNSProxy</h2>
<blockquote>
<p>Pcap_DNSProxy 是一个基于 WinPcap/LibPcap 用于过滤 DNS 投毒污染的工具，提供支持正则表达式的 Hosts 提供更便捷和强大的修改 Hosts 的方法，以及对 DNSCurve/DNSCrypt 协议、并行和 TCP 协议请求的支持。多服务器并行请求功能，更可提高在恶劣网络环境下域名解析的可靠性。</p>
</blockquote>
<p>看不懂？没关系，只需要知道这是一个帮助我们应对 DNS 污染的工具就行。</p>
<h3 id="下载安装">下载安装</h3>
<p>访问 <a href="https://github.com/chengr28/Pcap_DNSProxy" target="_blank" rel="external">Pcap_DNSProxy 的 GitHub 地址</a>，然后根据提示查看 <a href="https://github.com/chengr28/Pcap_DNSProxy/tree/master/Documents" target="_blank" rel="external">Documents 文件夹</a>。安装方法和使用步骤都在 ReadMe 文件里了，请根据自己的电脑系统选择对应的文件，默认就是 Windows，所以 Windows 用户直接查看 <code>ReadMe(zh_Hans).txt</code> 文件。下面我以 OS X 为例，简单讲解安装和使用过程。</p>
<ol>
<li>
<p>查看 <a href="https://github.com/chengr28/Pcap_DNSProxy/tree/master/Documents" target="_blank" rel="external">Documents 文件夹</a>里的 <code>ReadMe_Mac(zh_Hans).txt</code> 文件，然后按说明下载整个项目。</p>
</li>
<li>
<p>解压缩，然后把 Mac 文件夹单独拿出来，放到个人用户目录（放哪儿根据个人喜好），把文件夹重命名为 <code>Pcap_DNSProxy</code></p>
</li>
<li>
<p>进入文件夹，用任意文本编辑器打开 <code>pcap_dnsproxy.service.plist</code> 文件，修改第 9 和 11 行，把这里的地址修改成第 2 步文件夹的地址，如果和我一样是放在个人用户目录，那就是 <code>/Users/你的用户名/Pcap_DNSProxy/</code>。</p>
<p>（注意，第 9 行后面还要多一个 <code>Pcap_DNSProxy</code>，也就是 <code>/Users/你的用户名/Pcap_DNSProxy/Pcap_DNSProxy</code>。）</p>
<p>修改完后记得保存。</p>
</li>
<li>
<p>打开终端（找不到终端程序在哪的话，就打开 Spotlight 直接输入 <code>Terminal.app</code>，一般输到第 3 个字母就会显示了），输入命令 <code>sudo -i</code>，然后会提示你输入系统密码。注意，终端下输入密码是完全不显示的，所以输入时看上去好像什么都没有输入一样，其实已经输入了，不必惊讶。</p>
<ol>
<li>输完密码，就获取了 root 权限。这时候我们需要进入第 2 步的文件夹，因此输入 <code>cd /Users/你的用户名/Pcap_DNSProxy/</code>，终端有自动补全功能，例如当你输入 <code>Pcap</code> 的时候，直接按下 Tab 键，就会自动补全。输完以后，按回车进入。</li>
<li>输入命令 <code>chmod 755 Mac_Install.sh</code> 并回车，赋予这个 .sh 文件权限。</li>
<li>输入命令 <code>./Mac_Install.sh</code> 并回车，执行这个文件（bash 脚本）</li>
<li><code>control + D</code> 退出 root</li>
</ol>
</li>
<li>
<p>Pcap_DNSProxy 已经安装并运行好了，接下来修改本地 DNS 设置，使其生效。在菜单栏右上角点击 Wi-Fi 图标，选择「打开网络偏好设置」，然后点击右下角的「高级」，选择「DNS」，按左下角的 + 号，输入两个 DNS，分别为 <code>127.0.0.1</code> 和 <code>::1</code> 。</p>
<p>修改好后别忘了点「好」、「应用」保存。</p>
</li>
</ol>
<h3 id="修改设置">修改设置</h3>
<p>工作是完成了，但问题还有很多。比方说，你可能会感觉打开淘宝等国内网址，速度非常慢。因此，我们还需要针对性地做一些修改设置。</p>
<p>打开 <code>Pcap_DNSProxy</code> 所在文件夹，然后用任意文本编辑器打开 <code>Config.conf</code> 文件。找到 <code>[Local DNS]</code> 位置，可以把 <code>Local Hosts = 0</code> 由 0 设置成 1，这样的话，绝大部分中国网址都会走国内 DNS 网络，速度会更快。</p>
<p>找到 <code>[Addresses]</code> 位置，你可以把 <code>IPv4 Local DNS Address</code> 修改成自己喜欢的，一般来说默认的 114DNS 就足够好了。</p>
<p><code>Config.conf</code> 是 Pcap_DNSProxy 配置文件，所有功能设置都在这里，具体请参照 <a href="https://github.com/chengr28/Pcap_DNSProxy/tree/master/Documents" target="_blank" rel="external">Documents 文件夹</a>里的 <code>ReadMe(zh_Hans).txt</code> 文件。</p>
<h2 id="补充">补充</h2>
<p>获得正确的 DNS 解析不代表就彻底摆脱了 GFW。因此你还是需要必要的科学上网工具。有人可能会问，那获取正确 DNS 解析意义何在？</p>
<p>首先，有些网站的屏蔽程度比较低，仅仅只是 DNS 污染，因此获取正确 DNS 后，我们就可以直接访问这些网络了（如 Instagram，请用 HTTPS 访问，也就是 https://www.instagram.com/ ）。</p>
<p>其次，如果不获取正确的 DNS 解析，有时候哪怕你用了科学上网工具，也无法正常访问目标网络。毕竟，就算你开着再好的车，也不能达到一个根本不存在的地方，对吧？</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/互联网/" rel="tag"># 互联网</a>
          
            <a href="/tags/GFW/" rel="tag"># GFW</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/macOS-Setup/" rel="next" title="macOS 必要设置指南">
                <i class="fa fa-chevron-left"></i> macOS 必要设置指南
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Improve-the-Quality-of-Your-Life/" rel="prev" title="提高生活质量没那么难">
                提高生活质量没那么难 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/logo.png"
               alt="fysly" />
          <p class="site-author-name" itemprop="name">fysly</p>
          <p class="site-description motion-element" itemprop="description">随便写点东西</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">35</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/fysly" title="知乎" target="_blank">
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/fysly" title="GitHub" target="_blank">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/fysly" title="Twitter" target="_blank">
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:fysly@outlook.com" title="Email" >
                  
                  Email
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="/about/" title="关于我" >关于我</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#起因"><span class="nav-number">1.</span> <span class="nav-text">起因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#具体问题"><span class="nav-number">2.</span> <span class="nav-text">具体问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pcap-dnsproxy"><span class="nav-number">3.</span> <span class="nav-text">Pcap_DNSProxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载安装"><span class="nav-number">3.1.</span> <span class="nav-text">下载安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改设置"><span class="nav-number">3.2.</span> <span class="nav-text">修改设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充"><span class="nav-number">4.</span> <span class="nav-text">补充</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <!-- update loading -->
    
    <script type="text/javascript">
        $('.headband').animate({'width':'60%'}, 150);
    </script>
    

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fysly</span>
</div>



        

        
      </div>
    </footer>

    <!-- update loading -->
    
    <script type="text/javascript">
        $('.headband').animate({'width':'80%'}, 150);
    </script>
    

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




	




  
  

  

  

  


  <!-- update loading -->
  
  <script type="text/javascript">
      $('.headband').animate({'width':'100%'}, 150);
  </script>
  

</body>
</html>
